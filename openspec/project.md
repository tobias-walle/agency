# Project Context

## Purpose
Agency is a command-line AI agent orchestrator. It helps developers run one or more coding agents (e.g. Claude Code, Codex CLI, Gemini CLI, OpenCode) in isolated Git worktrees with tmux-managed sessions, while providing both a friendly TUI and a full-featured CLI. The daemon tracks sessions and notifies clients; the CLI/TUI attach to tmux for interactive work.

## Tech Stack
- Rust workspace (Edition 2024) with Rust >= 1.89
- Core crates: `clap` (CLI), `anyhow` (errors), `anstream` (streaming), `owo_colors` (colors)
- Process/session management: `tmux` for agent panes and sessions
- VCS isolation: Git Worktrees for per-task environments
- IPC: Unix domain socket between CLI/TUI and daemon
- Tooling: Cargo, Clippy, Nextest, `just` for scripts
- Platforms: macOS and Linux supported; Windows not supported

## Project Conventions

### Code Style
- Indent with 2 spaces
- Prefer ASCII punctuation; avoid long dashes and semicolons
- Do not use single-letter variables; prioritize clarity
- Favor readability; avoid heavy nesting
- Collapse `if` statements using `&&` pattern when possible
- Run `just check` and fix all warnings/errors, then `cargo fmt`
- Add dependencies via `cargo add`; do not edit `Cargo.toml` directly
- Use `bail!` for fatal errors; printed to stderr in red automatically
- Concurrency: prefer `parking_lot::Mutex`; short-lived lock scopes; helpers named `read_*` and `write_*`
- Avoid blocking I/O while holding locks; copy data out first
- Async: never use Tokio; prefer threads
- Git access: prefer `gix` over shelling out to `git` (unless unsupported)

### Logging (User-Facing)
- Use macros provided by the CLI/TUI, not `println!`/`eprintln!`:
  - `crate::log_info!` – neutral updates; can include token highlights
  - `crate::log_success!` – confirmations; entire line green
  - `crate::log_warn!` – recoverable issues; entire line yellow
  - `crate::log_error!` – failures; entire line red
- Token highlights for info lines via `use utils::log::t`:
  - `t::id`, `t::count` (blue), `t::slug` (bold), `t::branch` (magenta), `t::path`/`t::sha` (cyan)
- Wording: Uppercase start; verb-first; past tense for confirmations; ASCII only; no trailing period; use `->` for transitions
- Do not use token highlights in success/warn/error lines; reserve tokens for `log_info!`
- Examples:
  - `log_info!("Create task {} (id {})", t::slug(slug), t::id(id));`
  - `log_success!("Fast-forward {} to {} at {}", base, branch, sha);`
  - `log_warn!("Clean up: worktree, branch, file");`
  - `log_error!("Daemon error: {}", msg);`

### Logging (Daemon)
- Use the `log` crate (`log::info!`, `log::warn!`, `log::error!`, `log::debug!`, `log::trace!`) for structured diagnostics
- Include identifiers (task id, session id, paths) as plain values; do not apply token styling
- Prefer concise, machine-parseable phrasing; avoid user-facing styling or emojis

### Architecture Patterns
- Daemon + Client: a slim daemon computes session/task status from tmux and broadcasts notifications; CLI/TUI are clients
- TUI/CLI attach directly to tmux for interactive views; daemon communication via Unix socket
- IPC is event-driven: clients subscribe to daemon events; avoid polling in steady state. Polling is allowed only as a fallback when events are unavailable or during initial sync.
- Config layering: defaults → global (`~/.config/agency/agency.toml`) → project (`.agency/agency.toml`)
- Commands organized under `crates/agency/src/commands/`; shared helpers in `crates/agency/src/utils/`
- Key files: `crates/agency/src/main.rs`, `crates/agency/src/lib.rs`, `crates/agency/defaults/agency.toml`
- Directory structure: `crates/` workspace; tests under `crates/agency/tests/`; scripts in `justfile`

### Testing Strategy
- Run tests with `just test` (uses `cargo nextest run`)
- Place unit tests in the same file as the implementation (Rust best practice)
- CLI tests: use `assert_cmd::Command::cargo_bin("agency")`; chain calls; prefer pipes over PTY
- Files generated by tests should be written under `crates/agency/target/test-tmp` via `common::tmp_root()`
- Manage env vars with `temp-env` (`with_var`/`with_vars`) to avoid global mutations
- Prefer polling with bounded timeouts over fixed sleeps to reduce flakiness
- Use `gix` for local repository interactions in tests where possible
- Keep assertions high-signal (clear what/why, actual vs expected)

### Git Workflow
- Tasks are created and managed via Agency commands; each task runs in an isolated Git worktree and branch
- Typical flow: `agency new <slug>` → edit → `agency start <slug>` → work → `agency merge <slug>`
- Use `agency shell <slug>` and `agency attach <slug|id>` to interact with agent sessions
- Conventional Commits required; commit after each task step
- Commit format: single-line, verb-first, lowercase, no semicolons, <80 chars; body only for unexpected changes
- Run `just fix` before every commit to auto-fix lint warnings and format the code

## Domain Context
- Purpose: orchestrate CLI coding agents in parallel, each in its own tmux pane and Git worktree
- Agents configured in `agency.toml`; defaults include `claude`, `codex`, `gemini`, `opencode`
- Environment variables injected for agents: `$AGENCY_TASK`, `$AGENCY_ROOT`, `$AGENCY_TASK_ID`
- Tmux and socket paths support overrides via env/config; see README for precedence
- Task metadata and descriptions stored under `.agency/tasks/<slug>.md`
- The daemon tracks sessions via tmux and broadcasts status changes to clients

## Important Constraints
- OS support: macOS and Linux; Windows not supported
- Simplicity first: avoid unnecessary frameworks; choose proven patterns
- No Tokio; threading only for async/concurrency
- Use `parking_lot::Mutex` and centralized lock helpers; never perform blocking I/O while holding a lock
- Add dependencies with `cargo add`; prefer `just` scripts over direct cargo commands

## External Dependencies
- `tmux` (required) for session and pane management
- Git with Worktree support (required) for per-task isolation
- CLI agent binaries (user-provided): Claude Code, Codex CLI, Gemini CLI, OpenCode, or custom agents
- ripgrep (`rg`) recommended for fast search in workflows and specs
- Distribution options: NPM (`agency-cli`), Homebrew tap, or Cargo install from source
